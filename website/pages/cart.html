<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping Cart - Coveo Commerce Demo</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../styles/main.css">
    
    <!-- Coveo Atomic -->
    <script type="module" src="https://static.cloud.coveo.com/atomic/v3/atomic.esm.js"></script>
    <link rel="stylesheet" href="https://static.cloud.coveo.com/atomic/v3/themes/coveo.css"/>
    
    <script>
        // Initialize Atomic Commerce Interface for cart page
        (async () => {
            await customElements.whenDefined("atomic-commerce-interface");
            const cartInterface = document.querySelector("#cart-interface");

            await cartInterface.initialize({
                accessToken: "xxbca76af9-a943-41af-b024-5a71768f44c1",
                organizationId: "coveodocumentationtest",
                environment: "prod",
                analytics: {trackingId: 'commerce-docs-demo'},
                context: {
                    language: 'en',
                    country: 'CA',
                    currency: 'CAD',
                    view: {url: window.location.href}
                }
            });
        })();
    </script>
    
    <style>
        .cart-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .cart-item img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 4px;
        }
        .cart-item-details {
            flex-grow: 1;
        }
        .cart-item-name {
            font-weight: 600;
            font-size: 1.1rem;
        }
        .cart-item-price {
            color: #0066cc;
            font-size: 1.2rem;
            font-weight: 500;
        }
        .cart-summary {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            background-color: #f8f9fa;
            position: sticky;
            top: 20px;
        }
        .quantity-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .quantity-control button {
            width: 30px;
            height: 30px;
            padding: 0;
        }
        .empty-cart {
            text-align: center;
            padding: 60px 20px;
        }
        .empty-cart-icon {
            font-size: 80px;
            color: #ccc;
        }
    </style>
</head>
<body>
    <atomic-commerce-interface id="cart-interface" type="product-listing" analytics="true">
        <div class="container mt-4">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="simple-search.html">Home</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Shopping Cart</li>
                </ol>
            </nav>

            <h1 class="mb-4">Shopping Cart</h1>

            <div class="row">
                <!-- Cart Items -->
                <div class="col-lg-8">
                    <div id="cart-items-container">
                        <!-- Cart items will be rendered here -->
                    </div>
                    
                    <div id="empty-cart" class="empty-cart d-none">
                        <div class="empty-cart-icon">ðŸ›’</div>
                        <h3>Your cart is empty</h3>
                        <p class="text-muted">Add some products to get started!</p>
                        <a href="simple-search.html" class="btn btn-primary">Continue Shopping</a>
                    </div>
                </div>

                <!-- Cart Summary -->
                <div class="col-lg-4">
                    <div id="cart-summary" class="cart-summary d-none">
                        <h4 class="mb-3">Order Summary</h4>
                        
                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal (<span id="item-count">0</span> items):</span>
                            <span id="subtotal">$0.00</span>
                        </div>
                        
                        <div class="d-flex justify-content-between mb-2">
                            <span>Tax (estimate):</span>
                            <span id="tax">$0.00</span>
                        </div>
                        
                        <div class="d-flex justify-content-between mb-2">
                            <span>Shipping:</span>
                            <span id="shipping">$0.00</span>
                        </div>
                        
                        <hr>
                        
                        <div class="d-flex justify-content-between mb-3">
                            <strong>Total:</strong>
                            <strong class="text-primary" id="total">$0.00</strong>
                        </div>
                        
                        <button id="checkout-btn" class="btn btn-primary btn-lg w-100 mb-2">
                            Proceed to Checkout
                        </button>
                        
                        <button id="clear-cart-btn" class="btn btn-outline-danger w-100">
                            Clear Cart
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </atomic-commerce-interface>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Cart Page Controller - Version 2.0 (Updated for correct purchase event format)
        class CartPageController {
            constructor() {
                this.cart = [];
                this.TAX_RATE = 0.08; // 8% tax
                this.SHIPPING_COST = 10.00;
                this.FREE_SHIPPING_THRESHOLD = 100.00;
                this.init();
            }

            init() {
                this.loadCart();
                this.renderCart();
                this.bindEvents();
            }

            loadCart() {
                // Load cart from localStorage (simulated cart storage)
                const storedCart = localStorage.getItem('coveo-demo-cart');
                this.cart = storedCart ? JSON.parse(storedCart) : [];
            }

            saveCart() {
                localStorage.setItem('coveo-demo-cart', JSON.stringify(this.cart));
            }

            renderCart() {
                const container = document.getElementById('cart-items-container');
                const emptyCart = document.getElementById('empty-cart');
                const summary = document.getElementById('cart-summary');

                if (this.cart.length === 0) {
                    container.innerHTML = '';
                    emptyCart.classList.remove('d-none');
                    summary.classList.add('d-none');
                    return;
                }

                emptyCart.classList.add('d-none');
                summary.classList.remove('d-none');

                // Render cart items
                container.innerHTML = this.cart.map((item, index) => `
                    <div class="cart-item" data-index="${index}">
                        ${item.image ? `<img src="${item.image}" alt="${item.name}">` : '<div style="width: 80px; height: 80px; background: #f0f0f0; border-radius: 4px;"></div>'}
                        <div class="cart-item-details">
                            <div class="cart-item-name">${item.name}</div>
                            <div class="text-muted">${item.brand || ''}</div>
                            <div class="cart-item-price">$${item.price.toFixed(2)}</div>
                        </div>
                        <div class="quantity-control">
                            <button class="btn btn-sm btn-outline-secondary decrease-qty" data-index="${index}">-</button>
                            <input type="number" class="form-control form-control-sm text-center" style="width: 60px;" 
                                   value="${item.quantity}" min="1" data-index="${index}" readonly>
                            <button class="btn btn-sm btn-outline-secondary increase-qty" data-index="${index}">+</button>
                        </div>
                        <button class="btn btn-outline-danger btn-sm remove-item" data-index="${index}">Remove</button>
                    </div>
                `).join('');

                // Update summary
                this.updateSummary();
            }

            updateSummary() {
                const subtotal = this.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                const shipping = subtotal >= this.FREE_SHIPPING_THRESHOLD ? 0 : this.SHIPPING_COST;
                const tax = subtotal * this.TAX_RATE;
                const total = subtotal + tax + shipping;
                const itemCount = this.cart.reduce((sum, item) => sum + item.quantity, 0);

                document.getElementById('item-count').textContent = itemCount;
                document.getElementById('subtotal').textContent = `$${subtotal.toFixed(2)}`;
                document.getElementById('tax').textContent = `$${tax.toFixed(2)}`;
                document.getElementById('shipping').textContent = shipping === 0 ? 'FREE' : `$${shipping.toFixed(2)}`;
                document.getElementById('total').textContent = `$${total.toFixed(2)}`;
            }

            bindEvents() {
                // Increase quantity
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('increase-qty')) {
                        const index = parseInt(e.target.dataset.index);
                        this.cart[index].quantity++;
                        this.saveCart();
                        this.renderCart();
                    }
                });

                // Decrease quantity
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('decrease-qty')) {
                        const index = parseInt(e.target.dataset.index);
                        if (this.cart[index].quantity > 1) {
                            this.cart[index].quantity--;
                            this.saveCart();
                            this.renderCart();
                        }
                    }
                });

                // Remove item
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('remove-item')) {
                        const index = parseInt(e.target.dataset.index);
                        this.cart.splice(index, 1);
                        this.saveCart();
                        this.renderCart();
                    }
                });

                // Clear cart
                document.getElementById('clear-cart-btn').addEventListener('click', () => {
                    if (confirm('Are you sure you want to clear your cart?')) {
                        this.cart = [];
                        this.saveCart();
                        this.renderCart();
                    }
                });

                // Checkout
                document.getElementById('checkout-btn').addEventListener('click', async () => {
                    await this.checkout();
                });
            }

            async checkout() {
                if (this.cart.length === 0) return;

                const checkoutBtn = document.getElementById('checkout-btn');
                checkoutBtn.disabled = true;
                checkoutBtn.textContent = 'Processing...';

                try {
                    // Calculate totals
                    const subtotal = this.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                    const shipping = subtotal >= this.FREE_SHIPPING_THRESHOLD ? 0 : this.SHIPPING_COST;
                    const tax = subtotal * this.TAX_RATE;
                    const total = subtotal + tax + shipping;

                    // Track purchase event using Coveo Analytics
                    const cartInterface = document.querySelector('#cart-interface');
                    
                    if (cartInterface && cartInterface.engine) {
                        const purchasePayload = {
                            currency: 'CAD',
                            transaction: {
                                id: 'order_' + Date.now(),
                                revenue: total
                            },
                            products: this.cart.map(item => ({
                                product: {
                                    productId: item.productId,
                                    name: item.name,
                                    price: item.price
                                },
                                quantity: item.quantity
                            }))
                        };
                        
                        console.log('ðŸ“¦ Sending purchase event:', purchasePayload);
                        
                        await cartInterface.engine.relay.emit('ec.purchase', purchasePayload);

                        console.log('âœ… Purchase event tracked:', {
                            total: total,
                            items: this.cart.length,
                            products: this.cart.map(i => i.name)
                        });
                    }

                    // Simulate order processing
                    await new Promise(resolve => setTimeout(resolve, 1500));

                    // Clear cart
                    this.cart = [];
                    this.saveCart();

                    // Show success message
                    alert(`âœ… Order placed successfully!\n\nTotal: $${total.toFixed(2)}\nOrder ID: order_${Date.now()}\n\nPurchase event tracked in Coveo Analytics.`);
                    
                    this.renderCart();

                } catch (error) {
                    console.error('Checkout error:', error);
                    alert('There was an error processing your order. Please try again.');
                } finally {
                    checkoutBtn.disabled = false;
                    checkoutBtn.textContent = 'Proceed to Checkout';
                }
            }
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            new CartPageController();
        });
    </script>
</body>
</html>
