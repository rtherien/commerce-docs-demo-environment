<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Detail - Sports Store</title>
    <script type="module" src="https://static.cloud.coveo.com/atomic/v2/atomic.esm.js"></script>
    <link rel="stylesheet" href="https://static.cloud.coveo.com/atomic/v2/themes/coveo.css" />
    <link rel="stylesheet" href="../styles/main.css" />
</head>
<body>
    <!-- Navigation Header -->
    <header class="main-header">
        <div class="header-content">
            <div class="logo">
                <h1><a href="./index.html">Sports Store</a></h1>
            </div>
            <nav class="main-nav">
                <div class="nav-dropdown">
                    <button class="nav-dropdown-btn">Shop Categories â–¼</button>
                    <div class="nav-dropdown-content">
                        <a href="./plp-golf.html">Golf Equipment</a>
                        <a href="./plp-hockey.html">Hockey Equipment</a>
                        <a href="./plp-shoes.html">Athletic Shoes</a>
                    </div>
                </div>
                <div class="cart-container">
                    <button id="cart-toggle" class="cart-btn">
                        ðŸ›’ Cart (<span id="cart-count">0</span>)
                    </button>
                </div>
            </nav>
        </div>
    </header>

    <!-- Cart Sidebar -->
    <div id="cart-sidebar" class="cart-sidebar">
        <div class="cart-content">
            <div class="cart-header">
                <h3>Shopping Cart</h3>
                <button id="cart-close" class="cart-close">&times;</button>
            </div>
            <div id="cart-items" class="cart-items"></div>
            <div class="cart-footer">
                <div class="cart-total">
                    Total: $<span id="cart-total">0.00</span>
                </div>
                <button id="checkout-btn" class="checkout-btn">Complete Purchase</button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="pdp-container">
        <div id="product-loading" class="loading">
            <p>Loading product details...</p>
        </div>

        <div id="product-detail" class="product-detail" style="display: none;">
            <div class="product-images">
                <img id="product-image" class="main-product-image" src="" alt="">
            </div>
            <div class="product-info">
                <h1 id="product-name"></h1>
                <p id="product-brand" class="product-brand"></p>
                <div id="product-price" class="product-price-large"></div>
                <div id="product-description" class="product-description"></div>
                <button id="add-to-cart-large" class="add-to-cart-large">Add to Cart</button>
            </div>
        </div>

        <!-- Related Products Section -->
        <div class="related-products">
            <h3>Related Products</h3>
            <atomic-commerce-interface
                id="related-products-interface"
                organization-id="coveodocumentationtest"
                tracking-id="commerce-docs-demo"
                type="search"
                language-assets-path="./lang"
                icon-assets-path="./assets"
            >
                <atomic-commerce-layout>
                    <atomic-layout-section section="products">
                        <atomic-commerce-product-list
                            display="grid"
                            density="compact"
                            image-size="small"
                        >
                            <atomic-product-template>
                                <template>
                                    <atomic-product-section-name>
                                        <atomic-product-link class="product-link"></atomic-product-link>
                                    </atomic-product-section-name>
                                    <atomic-product-section-visual>
                                        <atomic-product-image field="ec_thumbnails"></atomic-product-image>
                                    </atomic-product-section-visual>
                                    <atomic-product-section-metadata>
                                        <atomic-product-text field="ec_brand" class="product-brand"></atomic-product-text>
                                    </atomic-product-section-metadata>
                                    <atomic-product-section-emphasized>
                                        <atomic-product-price currency="CAD" class="product-price"></atomic-product-price>
                                    </atomic-product-section-emphasized>
                                    <atomic-product-section-children>
                                        <button class="add-to-cart-btn" onclick="addToCart(this)">Add to Cart</button>
                                    </atomic-product-section-children>
                                </template>
                            </atomic-product-template>
                        </atomic-commerce-product-list>
                    </atomic-layout-section>
                </atomic-layout-section>
            </atomic-commerce-interface>
        </div>
    </div>

    <script src="../js/cart.js"></script>
    <script src="../js/coveo-analytics.js"></script>
    <script>
        let currentProduct = null;
        let commerceInterface = null;
        let relatedProductsInterface = null;

        // Get product ID from URL parameters
        function getProductIdFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }

        // Load product details
        async function loadProductDetails(productId) {
            try {
                const loadingElement = document.getElementById('product-loading');
                const detailElement = document.getElementById('product-detail');

                // Initialize main commerce interface for product lookup
                await customElements.whenDefined('atomic-commerce-interface');
                
                // Create a temporary search interface to find the product
                const searchInterface = document.createElement('atomic-commerce-interface');
                searchInterface.setAttribute('organization-id', 'coveodocumentationtest');
                searchInterface.setAttribute('tracking-id', 'commerce-docs-demo');
                searchInterface.setAttribute('type', 'search');
                searchInterface.style.display = 'none';
                document.body.appendChild(searchInterface);

                await searchInterface.initialize({
                    accessToken: 'xxd749992c-d0b5-475f-95e6-671793e6c94a',
                    organizationId: 'coveodocumentationtest',
                    environment: 'prod',
                    platform: 'cloud',
                    analytics: {
                        trackingId: 'commerce-docs-demo',
                        analyticsMode: 'next'
                    },
                    context: {
                        language: 'en',
                        country: 'CA',
                        currency: 'CAD',
                        view: {
                            url: 'https://sports-store.com/product/' + productId
                        },
                        user: {
                            userAgent: navigator.userAgent
                        }
                    }
                });

                // Search for the specific product
                const searchResults = await searchInterface.executeQuery({
                    q: '',
                    aq: `@permanentid="${productId}" OR @uniqueId="${productId}"`
                });

                if (searchResults && searchResults.results && searchResults.results.length > 0) {
                    const product = searchResults.results[0];
                    currentProduct = {
                        id: product.permanentid || product.uniqueId,
                        name: product.raw.ec_name || product.title,
                        price: product.raw.ec_price,
                        image: product.raw.ec_thumbnails && product.raw.ec_thumbnails.length > 0 
                               ? product.raw.ec_thumbnails[0] : './assets/no-image.png',
                        brand: product.raw.ec_brand || '',
                        description: product.raw.ec_description || product.excerpt || 'No description available.'
                    };

                    displayProductDetails(currentProduct);
                    
                    // Track product view
                    trackProductViewEvent(currentProduct);
                    
                    // Load related products
                    await loadRelatedProducts(currentProduct.brand || 'sports');
                } else {
                    showProductNotFound();
                }

                // Clean up temporary interface
                document.body.removeChild(searchInterface);

            } catch (error) {
                console.error('Error loading product:', error);
                showProductNotFound();
            }
        }

        // Display product details
        function displayProductDetails(product) {
            const loadingElement = document.getElementById('product-loading');
            const detailElement = document.getElementById('product-detail');

            // Update product information
            document.getElementById('product-name').textContent = product.name;
            document.getElementById('product-brand').textContent = product.brand;
            document.getElementById('product-price').textContent = `$${product.price ? product.price.toFixed(2) : '0.00'}`;
            document.getElementById('product-description').textContent = product.description;
            document.getElementById('product-image').src = product.image;
            document.getElementById('product-image').alt = product.name;

            // Update page title
            document.title = `${product.name} - Sports Store`;

            // Show product details, hide loading
            loadingElement.style.display = 'none';
            detailElement.style.display = 'grid';

            // Setup add to cart button
            const addToCartBtn = document.getElementById('add-to-cart-large');
            addToCartBtn.onclick = function() {
                addProductToCart(product);
                trackAddToCartEvent(product);
                
                this.textContent = 'Added to Cart!';
                setTimeout(() => {
                    this.textContent = 'Add to Cart';
                }, 2000);
            };
        }

        // Show product not found message
        function showProductNotFound() {
            const loadingElement = document.getElementById('product-loading');
            loadingElement.innerHTML = `
                <p>Product not found.</p>
                <p><a href="/">Return to Search</a></p>
            `;
        }

        // Load related products
        async function loadRelatedProducts(category) {
            try {
                relatedProductsInterface = document.getElementById('related-products-interface');
                
                await relatedProductsInterface.initialize({
                    accessToken: 'xxd749992c-d0b5-475f-95e6-671793e6c94a',
                    organizationId: 'coveodocumentationtest',
                    environment: 'prod',
                    platform: 'cloud',
                    analytics: {
                        trackingId: 'commerce-docs-demo',
                        analyticsMode: 'next'
                    },
                    context: {
                        language: 'en',
                        country: 'CA',
                        currency: 'CAD',
                        view: {
                            url: 'https://sports-store.com/related/' + category
                        },
                        user: {
                            userAgent: navigator.userAgent
                        }
                    }
                });

                // Execute search for related products
                relatedProductsInterface.executeQuery({
                    q: category,
                    numberOfResults: 4
                });

                // Setup product links for related products
                setupRelatedProductLinks();

            } catch (error) {
                console.error('Error loading related products:', error);
            }
        }

        // Setup product links for related products
        function setupRelatedProductLinks() {
            document.addEventListener('click', (e) => {
                if (e.target.closest('.product-link')) {
                    e.preventDefault();
                    const productLink = e.target.closest('.product-link');
                    const productData = getProductDataFromElement(productLink);
                    if (productData) {
                        window.location.href = `./pdp.html?id=${encodeURIComponent(productData.id)}`;
                    }
                }
            });
        }

        // Extract product data from DOM element
        function getProductDataFromElement(element) {
            const productContainer = element.closest('atomic-product-template').parentElement;
            try {
                const productElement = productContainer.querySelector('atomic-product-template');
                if (productElement && productElement.product) {
                    return {
                        id: productElement.product.permanentid || productElement.product.uniqueId,
                        name: productElement.product.ec_name || productElement.product.title,
                        price: productElement.product.ec_price,
                        image: productElement.product.ec_thumbnails?.[0],
                        brand: productElement.product.ec_brand
                    };
                }
            } catch (error) {
                console.warn('Could not extract product data:', error);
            }
            return null;
        }

        // Global function for add to cart in related products
        window.addToCart = function(button) {
            const productData = getProductDataFromElement(button);
            if (productData) {
                addProductToCart(productData);
                trackAddToCartEvent(productData);
                
                button.textContent = 'Added!';
                setTimeout(() => {
                    button.textContent = 'Add to Cart';
                }, 1500);
            }
        };

        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize cart and analytics
            initializeCart();
            initializeCoveoAnalytics();

            // Track page view
            trackPageViewEvent('product-detail', window.location.href);

            // Get product ID and load details
            const productId = getProductIdFromURL();
            if (productId) {
                await loadProductDetails(productId);
            } else {
                showProductNotFound();
            }
        });
    </script>
</body>
</html>