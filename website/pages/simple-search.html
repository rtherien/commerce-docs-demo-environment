<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sports Store - Search</title>
    <script type="module" src="https://static.cloud.coveo.com/atomic/v3/atomic.esm.js"></script>
    <link rel="stylesheet" href="https://static.cloud.coveo.com/atomic/v3/themes/coveo.css">
    <link rel="stylesheet" href="../styles/main.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>Sports Store</h1>
            <nav class="nav">
                <a href="simple-search.html">Search</a>
                <a href="simple-plp-shoes.html">Shoes</a>
                <a href="simple-plp-hockey.html">Hockey</a>
                <a href="simple-plp-golf.html">Golf</a>
            </nav>
        </header>

        <main class="main-content">
            <atomic-commerce-interface
                organization-id="coveodocumentationtest"
                tracking-id="commerce-docs-demo"
                type="search"
            >
                <atomic-commerce-layout>
                    <atomic-layout-section section="search">
                        <atomic-commerce-search-box></atomic-commerce-search-box>
                    </atomic-layout-section>
                    
                    <atomic-layout-section section="main">
                        <atomic-layout-section section="status">
                            <atomic-commerce-query-summary></atomic-commerce-query-summary>
                            <atomic-commerce-sort-dropdown></atomic-commerce-sort-dropdown>
                        </atomic-layout-section>
                        
                        <atomic-layout-section section="results">
                            <atomic-commerce-product-list>
                                <atomic-product-template>
                                    <template>
                                        <div class="grouped-product-card">
                                            <atomic-product-section-visual class="product-main-image">
                                                <atomic-product-image field="ec_images"></atomic-product-image>
                                            </atomic-product-section-visual>
                                            
                                            <atomic-product-section-name class="product-title">
                                                <atomic-product-link href="product-detail-simple.html/search/${ec_product_id}" class="product-link">
                                                    <atomic-product-text field="ec_name"></atomic-product-text>
                                                </atomic-product-link>
                                            </atomic-product-section-name>
                                            
                                            <atomic-product-section-metadata class="product-details">
                                                <atomic-product-text field="ec_brand" class="product-brand"></atomic-product-text>
                                                <atomic-product-text field="ec_category" class="product-category"></atomic-product-text>
                                            </atomic-product-section-metadata>
                                            
                                            <atomic-product-section-emphasized class="product-pricing">
                                                <atomic-product-price currency="CAD"></atomic-product-price>
                                            </atomic-product-section-emphasized>
                                            
                                            <!-- Native Atomic Commerce Product Grouping -->
                                            <atomic-product-section-children class="product-variants">
                                                <atomic-product-children label="Also available in:"></atomic-product-children>
                                            </atomic-product-section-children>
                                        </div>
                                    </template>
                                </atomic-product-template>
                            </atomic-commerce-product-list>
                        </atomic-layout-section>
                        
                        <atomic-layout-section section="pagination">
                            <atomic-commerce-pager></atomic-commerce-pager>
                        </atomic-layout-section>
                    </atomic-layout-section>
                </atomic-commerce-layout>
            </atomic-commerce-interface>
        </main>
    </div>

    <script>
        console.log('Starting simple search page...');
        
        (async () => {
            try {
                console.log('Waiting for atomic-commerce-interface to be defined...');
                await customElements.whenDefined('atomic-commerce-interface');
                console.log('atomic-commerce-interface is now defined');
                
                const commerceInterface = document.querySelector('atomic-commerce-interface');
                console.log('Commerce interface element:', commerceInterface);
                
                console.log('Initializing interface...');
                await commerceInterface.initialize({
                    accessToken: 'xxd749992c-d0b5-475f-95e6-671793e6c94a',
                    organizationId: 'coveodocumentationtest',
                    environment: 'prod',
                    analytics: {
                        trackingId: 'commerce-docs-demo'
                    },
                    context: {
                        language: 'en',
                        country: 'CA',
                        currency: 'CAD',
                        view: {
                            url: 'https://sports-store.com/search'
                        }
                    }
                });
                console.log('Interface initialized successfully');

                // Add response listener
                commerceInterface.addEventListener('responseReceived', (event) => {
                    const products = event.detail?.response?.products || [];
                    console.log(`Found ${products.length} products:`, products.map(p => p.ec_name));
                });

                // Execute initial search to show products by default
                console.log('Executing initial search to show all products...');
                await commerceInterface.executeFirstRequest();
                console.log('Initial search completed');

                console.log('Interface ready - you can now search for products');
                
                // Add comprehensive event debugging
                commerceInterface.addEventListener('analyticsActionCause', (event) => {
                    console.log('üéØ Analytics Event Fired:', event.detail);
                });

                // Listen for all possible events on the commerce interface
                const eventTypes = ['click', 'clickEvent', 'analyticsEvent', 'commerce-click', 'product-click'];
                eventTypes.forEach(eventType => {
                    commerceInterface.addEventListener(eventType, (event) => {
                        console.log(`üìä ${eventType}:`, event.detail);
                    });
                });

                // Listen for click events on product links and log but allow navigation
                document.addEventListener('click', (event) => {
                    const productLink = event.target.closest('atomic-product-link');
                    if (productLink) {
                        console.log('üñ±Ô∏è Product link clicked:', productLink);
                        console.log('üîó Link href:', productLink.getAttribute('href'));
                        
                        const productCard = productLink.closest('div[class*=\"product\"]');
                        if (productCard) {
                            console.log('üì¶ Product card found:', productCard);
                        }
                        
                        // Allow the click to proceed but add a small delay to see logs
                        setTimeout(() => {
                            console.log('‚è∞ Click processed, checking for analytics...');
                        }, 100);
                    }
                });

                // Monitor for any analytics events sent to Coveo
                const originalFetch = window.fetch;
                window.fetch = function(...args) {
                    if (args[0] && args[0].includes && args[0].includes('analytics.cloud.coveo.com')) {
                        console.log('üì° Analytics request detected:', args[0]);
                        if (args[1] && args[1].body) {
                            try {
                                console.log('üìä Analytics payload:', JSON.parse(args[1].body));
                            } catch (e) {
                                console.log('üìä Analytics payload (raw):', args[1].body);
                            }
                        }
                    }
                    return originalFetch.apply(this, args);
                };
                
            } catch (error) {
                console.error('Error in simple search initialization:', error);
            }
        })();
    </script>
</body>
</html>