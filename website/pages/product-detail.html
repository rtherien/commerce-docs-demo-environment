<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Details - Sports Store</title>
    <script type="module" src="https://static.cloud.coveo.com/atomic/v3/atomic.esm.js"></script>
    <link rel="stylesheet" href="https://static.cloud.coveo.com/atomic/v3/themes/coveo.css">
    <link rel="stylesheet" href="../styles/main.css">
    <style>
        .product-detail-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 2rem;
        }
        
        .product-detail-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 3rem;
            margin-bottom: 3rem;
        }
        
        .product-image-section img {
            width: 100%;
            max-width: 500px;
            height: auto;
            border-radius: 8px;
        }
        
        .product-info-section h1 {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: #333;
        }
        
        .product-price {
            font-size: 1.5rem;
            font-weight: bold;
            color: #e74c3c;
            margin: 1rem 0;
        }
        
        .product-description {
            margin: 1.5rem 0;
            line-height: 1.6;
            color: #666;
        }
        
        .add-to-cart-btn {
            background: #2c5aa0;
            color: white;
            border: none;
            padding: 1rem 2rem;
            font-size: 1.1rem;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .add-to-cart-btn:hover {
            background: #1e4080;
        }
        
        .product-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }
        
        .meta-item {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
        }
        
        .meta-item strong {
            display: block;
            color: #333;
            margin-bottom: 0.5rem;
        }
        
        @media (max-width: 768px) {
            .product-detail-content {
                grid-template-columns: 1fr;
                gap: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>Sports Store</h1>
            <nav class="nav">
                <a href="simple-search.html">Search</a>
                <a href="simple-plp-shoes.html">Shoes</a>
                <a href="simple-plp-hockey.html">Hockey</a>
                <a href="simple-plp-golf.html">Golf</a>
                <div class="cart-icon" onclick="toggleCart()">
                    ðŸ›’ <span id="cart-count">0</span>
                </div>
            </nav>
        </header>

        <div class="product-detail-container">
            <!-- Loading state -->
            <div id="loading" style="text-align: center; padding: 3rem;">
                <p>Loading product details...</p>
            </div>

            <!-- Product details will be populated here -->
            <div id="product-content" style="display: none;">
                <div class="product-detail-content">
                    <div class="product-image-section">
                        <img id="product-image" src="" alt="Product Image">
                    </div>
                    
                    <div class="product-info-section">
                        <h1 id="product-name"></h1>
                        <div class="product-price" id="product-price"></div>
                        <div class="product-description" id="product-description"></div>
                        
                        <div class="product-meta">
                            <div class="meta-item">
                                <strong>Brand</strong>
                                <span id="product-brand"></span>
                            </div>
                            <div class="meta-item">
                                <strong>Category</strong>
                                <span id="product-category"></span>
                            </div>
                            <div class="meta-item">
                                <strong>SKU</strong>
                                <span id="product-sku"></span>
                            </div>
                        </div>
                        
                        <button class="add-to-cart-btn" id="add-to-cart-btn" onclick="addToCart()">
                            Add to Cart
                        </button>
                    </div>
                </div>

                <!-- Recommendations section -->
                <div class="recommendations-section">
                    <h3>Recommended Products</h3>
                    <atomic-commerce-interface
                        id="recs-interface"
                        organization-id="coveodocumentationtest"
                        tracking-id="commerce-docs-demo"
                        type="recommendation"
                    >
                        <atomic-commerce-layout>
                            <atomic-layout-section section="main">
                                <atomic-commerce-recommendation-list>
                                    <atomic-product-template>
                                        <template>
                                            <div class="recommendation-card" onclick="navigateToProduct('${clickUri}', '${ec_product_id}')">
                                                <atomic-product-section-visual>
                                                    <atomic-product-image field="ec_images"></atomic-product-image>
                                                </atomic-product-section-visual>
                                                <atomic-product-section-name>
                                                    <atomic-product-text field="ec_name"></atomic-product-text>
                                                </atomic-product-section-name>
                                                <atomic-product-section-emphasized>
                                                    <atomic-product-price currency="CAD"></atomic-product-price>
                                                </atomic-product-section-emphasized>
                                            </div>
                                        </template>
                                    </atomic-product-template>
                                </atomic-commerce-recommendation-list>
                            </atomic-layout-section>
                        </atomic-commerce-layout>
                    </atomic-commerce-interface>
                </div>
            </div>
        </div>
    </div>

    <!-- Cart sidebar -->
    <div id="cart-sidebar" class="cart-sidebar">
        <div class="cart-header">
            <h3>Shopping Cart</h3>
            <button onclick="toggleCart()" class="close-cart">Ã—</button>
        </div>
        <div id="cart-items"></div>
        <div class="cart-footer">
            <div class="cart-total">
                Total: <span id="cart-total">$0.00</span>
            </div>
            <button class="checkout-btn" onclick="checkout()">Checkout</button>
        </div>
    </div>

    <script src="../js/cart.js"></script>
    <script>
        let currentProduct = null;
        let commerceEngine = null;

        async function initializeCommerce() {
            try {
                console.log('Initializing commerce interface...');
                
                // Initialize main Coveo Analytics for PDP view tracking
                if (typeof CoveoAnalytics !== 'undefined') {
                    window.coveoAnalytics = new CoveoAnalytics.CoveoAnalytics({
                        token: 'xxd749992c-d0b5-475f-95e6-671793e6c94a',
                        endpoint: 'https://analytics.cloud.coveo.com/rest/organizations/coveodocumentationtest/analytics/',
                        userId: 'anonymous',
                        searchHub: 'commerce-docs-demo'
                    });
                }

                // Initialize recommendations interface
                await customElements.whenDefined('atomic-commerce-interface');
                const recsInterface = document.querySelector('#recs-interface');
                
                if (recsInterface) {
                    await recsInterface.initialize({
                        accessToken: 'xxd749992c-d0b5-475f-95e6-671793e6c94a',
                        organizationId: 'coveodocumentationtest',
                        environment: 'prod',
                        analytics: {
                            trackingId: 'commerce-docs-demo'
                        },
                        context: {
                            language: 'en',
                            country: 'CA',
                            currency: 'CAD',
                            view: {
                                url: window.location.href
                            }
                        }
                    });
                    console.log('Recommendations interface initialized');
                }

            } catch (error) {
                console.error('Error initializing commerce:', error);
            }
        }

        async function loadProductDetails() {
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('id');
            
            if (!productId) {
                document.getElementById('loading').innerHTML = '<p>No product specified. <a href="simple-search.html">Return to search</a></p>';
                return;
            }

            try {
                // Simulate fetching product details
                // In a real implementation, you'd fetch from Coveo or your product API
                const mockProduct = {
                    id: productId,
                    name: 'Product Name',
                    price: '$99.99',
                    description: 'This is a detailed description of the product...',
                    image: '../assets/images/placeholder-product.jpg',
                    brand: 'Brand Name',
                    category: 'Category',
                    sku: productId
                };

                currentProduct = mockProduct;
                displayProduct(mockProduct);
                
                // Log product view event
                logProductViewEvent(mockProduct);
                
                // Load recommendations
                if (document.querySelector('#recs-interface')) {
                    // Set recommendation context based on current product
                    // This would typically be done through the Coveo interface
                }

            } catch (error) {
                console.error('Error loading product:', error);
                document.getElementById('loading').innerHTML = '<p>Error loading product. <a href="simple-search.html">Return to search</a></p>';
            }
        }

        function displayProduct(product) {
            document.getElementById('product-name').textContent = product.name;
            document.getElementById('product-price').textContent = product.price;
            document.getElementById('product-description').textContent = product.description;
            document.getElementById('product-image').src = product.image;
            document.getElementById('product-image').alt = product.name;
            document.getElementById('product-brand').textContent = product.brand;
            document.getElementById('product-category').textContent = product.category;
            document.getElementById('product-sku').textContent = product.sku;
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('product-content').style.display = 'block';
            
            // Update page title
            document.title = `${product.name} - Sports Store`;
        }

        function logProductViewEvent(product) {
            console.log('Logging product view event for:', product.id);
            
            // Log using Coveo Analytics following the event protocol
            if (window.coveoAnalytics) {
                window.coveoAnalytics.logProductView({
                    productId: product.id,
                    productName: product.name,
                    productPrice: parseFloat(product.price.replace('$', '').replace(',', '')),
                    productBrand: product.brand,
                    productCategory: product.category
                });
            }

            // Alternative: Direct API call to Coveo Analytics
            fetch('https://analytics.cloud.coveo.com/rest/organizations/coveodocumentationtest/analytics/view', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer xxd749992c-d0b5-475f-95e6-671793e6c94a',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    language: 'en',
                    userAgent: navigator.userAgent,
                    customData: {
                        context_website: 'sports-store.com',
                        context_page: 'product_detail',
                        context_product_id: product.id,
                        context_product_name: product.name,
                        context_product_price: product.price
                    },
                    anonymous: true,
                    location: window.location.href,
                    referrer: document.referrer || '',
                    title: document.title,
                    viewMethod: 'product_view'
                })
            }).catch(error => {
                console.error('Error logging product view:', error);
            });
        }

        function navigateToProduct(clickUri, productId) {
            // Log click event before navigation
            logProductClickEvent(productId);
            
            // Navigate to product detail page
            window.location.href = `product-detail.html?id=${encodeURIComponent(productId)}`;
        }

        function logProductClickEvent(productId) {
            console.log('Logging product click event for:', productId);
            
            // Log click event using Coveo Analytics
            fetch('https://analytics.cloud.coveo.com/rest/organizations/coveodocumentationtest/analytics/click', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer xxd749992c-d0b5-475f-95e6-671793e6c94a',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    language: 'en',
                    userAgent: navigator.userAgent,
                    customData: {
                        context_website: 'sports-store.com',
                        context_page: 'recommendations',
                        context_product_id: productId
                    },
                    anonymous: true,
                    location: window.location.href,
                    referrer: document.referrer || '',
                    actionCause: 'productClick'
                })
            }).catch(error => {
                console.error('Error logging product click:', error);
            });
        }

        function addToCart() {
            if (!currentProduct) return;
            
            // Add to cart using existing cart functionality
            if (typeof addItemToCart === 'function') {
                addItemToCart({
                    id: currentProduct.id,
                    name: currentProduct.name,
                    price: parseFloat(currentProduct.price.replace('$', '').replace(',', '')),
                    image: currentProduct.image,
                    quantity: 1
                });
                
                // Update cart display
                updateCartDisplay();
                
                // Show confirmation
                alert(`${currentProduct.name} added to cart!`);
            }
        }

        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeCommerce();
            loadProductDetails();
            updateCartDisplay();
        });
    </script>

    <!-- Include Coveo Analytics for direct event tracking -->
    <script src="https://static.cloud.coveo.com/analytics/analytics.js"></script>
</body>
</html>