<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sports Store - Search & Shop</title>
    <script type="module" src="https://static.cloud.coveo.com/atomic/v3/atomic.esm.js"></script>
    <link rel="stylesheet" href="https://static.cloud.coveo.com/atomic/v3/themes/coveo.css" />
    <link rel="stylesheet" href="../styles/main.css" />
</head>
<body>
    <!-- Navigation Header -->
    <header class="main-header">
        <div class="header-content">
            <div class="logo">
                <h1><a href="./index.html">Sports Store</a></h1>
            </div>
            <nav class="main-nav">
                <div class="nav-dropdown">
                    <button class="nav-dropdown-btn">Shop Categories â–¼</button>
                    <div class="nav-dropdown-content">
                        <a href="./plp-golf.html">Golf Equipment</a>
                        <a href="./plp-hockey.html">Hockey Equipment</a>
                        <a href="./plp-shoes.html">Athletic Shoes</a>
                    </div>
                </div>
                <div class="cart-container">
                    <button id="cart-toggle" class="cart-btn">
                        ðŸ›’ Cart (<span id="cart-count">0</span>)
                    </button>
                </div>
            </nav>
        </div>
    </header>

    <!-- Cart Sidebar -->
    <div id="cart-sidebar" class="cart-sidebar">
        <div class="cart-content">
            <div class="cart-header">
                <h3>Shopping Cart</h3>
                <button id="cart-close" class="cart-close">&times;</button>
            </div>
            <div id="cart-items" class="cart-items"></div>
            <div class="cart-footer">
                <div class="cart-total">
                    Total: $<span id="cart-total">0.00</span>
                </div>
                <button id="checkout-btn" class="checkout-btn">Complete Purchase</button>
            </div>
        </div>
    </div>

    <!-- Main Search Interface -->
    <main class="main-content">
        <div class="search-hero">
            <h2>Find Your Perfect Sports Equipment</h2>
            <p>Search through thousands of products from top brands</p>
        </div>

        <atomic-commerce-interface
            organization-id="coveodocumentationtest"
            tracking-id="commerce-docs-demo"
            type="search"
            language-assets-path="./lang"
            icon-assets-path="./assets"
        >
            <atomic-commerce-layout>
                <atomic-layout-section section="search">
                    <atomic-commerce-search-box placeholder="Search for sports equipment..."></atomic-commerce-search-box>
                </atomic-layout-section>
                
                <atomic-layout-section section="facets">
                    <atomic-commerce-facets>
                        <atomic-commerce-facet field="ec_category" label="Category"></atomic-commerce-facet>
                        <atomic-commerce-facet field="ec_brand" label="Brand"></atomic-commerce-facet>
                        <atomic-commerce-facet field="ec_price" label="Price" type="numericalRange"></atomic-commerce-facet>
                        <atomic-commerce-facet field="ec_rating" label="Rating" type="numericalRange"></atomic-commerce-facet>
                        <atomic-commerce-facet field="ec_color" label="Color"></atomic-commerce-facet>
                        <atomic-commerce-facet field="ec_size" label="Size"></atomic-commerce-facet>
                    </atomic-commerce-facets>
                </atomic-layout-section>
                
                <atomic-layout-section section="main">
                    <atomic-layout-section section="status">
                        <atomic-commerce-breadbox></atomic-commerce-breadbox>
                        <atomic-commerce-query-summary></atomic-commerce-query-summary>
                        <atomic-commerce-sort-dropdown></atomic-commerce-sort-dropdown>
                        <atomic-commerce-refine-toggle></atomic-commerce-refine-toggle>
                    </atomic-layout-section>
                    
                    <atomic-layout-section section="products">
                        <atomic-commerce-product-list
                            display="grid"
                            density="normal"
                            image-size="large"
                        >
                            <atomic-product-template>
                                <template>
                                    <atomic-product-section-name>
                                        <atomic-product-link class="product-link"></atomic-product-link>
                                    </atomic-product-section-name>
                                    <atomic-product-section-visual>
                                        <atomic-product-image field="ec_thumbnails,ec_images,ec_image"></atomic-product-image>
                                    </atomic-product-section-visual>
                                    <atomic-product-section-metadata>
                                        <atomic-product-text field="ec_brand" class="product-brand"></atomic-product-text>
                                        <atomic-product-rating field="ec_rating"></atomic-product-rating>
                                    </atomic-product-section-metadata>
                                    <atomic-product-section-emphasized>
                                        <atomic-product-price currency="CAD" class="product-price"></atomic-product-price>
                                    </atomic-product-section-emphasized>
                                    <atomic-product-section-children>
                                        <button class="add-to-cart-btn" onclick="addToCart(this)">Add to Cart</button>
                                    </atomic-product-section-children>
                                </template>
                            </atomic-product-template>
                        </atomic-commerce-product-list>
                        <atomic-commerce-query-error></atomic-commerce-query-error>
                        <atomic-commerce-no-products></atomic-commerce-no-products>
                    </atomic-layout-section>
                    
                    <atomic-layout-section section="pagination">
                        <atomic-commerce-load-more-products></atomic-commerce-load-more-products>
                    </atomic-layout-section>
                </atomic-layout-section>
            </atomic-commerce-layout>
        </atomic-commerce-interface>
    </main>

    <script src="../js/cart.js"></script>
    <script src="../js/coveo-analytics.js"></script>
    <script>
        (async () => {
            await customElements.whenDefined('atomic-commerce-interface');
            
            const commerceInterface = document.querySelector('atomic-commerce-interface');
            
            await commerceInterface.initialize({
                accessToken: 'xxd749992c-d0b5-475f-95e6-671793e6c94a',
                organizationId: 'coveodocumentationtest',
                environment: 'prod',
                platform: 'cloud',
                analytics: {
                    trackingId: 'commerce-docs-demo',
                    analyticsMode: 'next'
                },
                context: {
                    language: 'en',
                    country: 'CA',
                    currency: 'CAD',
                    view: {
                        url: 'https://sports-store.com/search'
                    },
                    user: {
                        userAgent: navigator.userAgent
                    }
                }
            });

            // Initialize cart functionality
            initializeCart(commerceInterface);
            
            // Setup product link clicks to go to PDP
            setupProductLinks();

            commerceInterface.executeFirstRequest();
        })();

        // Function to handle product links to PDP
        function setupProductLinks() {
            document.addEventListener('click', (e) => {
                if (e.target.closest('.product-link')) {
                    e.preventDefault();
                    const productLink = e.target.closest('.product-link');
                    const productData = getProductDataFromElement(productLink);
                    if (productData) {
                        window.location.href = `./pdp.html?id=${encodeURIComponent(productData.id)}`;
                    }
                }
            });
        }

        // Function to extract product data from DOM element
        function getProductDataFromElement(element) {
            try {
                // Find the closest atomic-product-template
                const productTemplate = element.closest('atomic-product-template');
                if (!productTemplate) {
                    console.warn('No product template found');
                    return null;
                }

                // Get product data from the template's result property
                const result = productTemplate.result;
                if (result) {
                    return {
                        id: result.permanentid || result.uniqueId || result.raw.permanentid,
                        name: result.title || result.raw.ec_name || result.raw.title,
                        price: result.raw.ec_price || 0,
                        image: result.raw.ec_thumbnails?.[0] || result.raw.ec_images?.[0] || result.raw.ec_image || result.raw.ec_thumbnail,
                        brand: result.raw.ec_brand || '',
                        description: result.raw.ec_description || result.excerpt || ''
                    };
                }

                // Fallback: try to get data from the commerce interface
                const commerceInterface = document.querySelector('atomic-commerce-interface');
                if (commerceInterface && commerceInterface.state && commerceInterface.state.products) {
                    // Try to match by template position or other means
                    const products = commerceInterface.state.products;
                    if (products.length > 0) {
                        // For now, return the first product as fallback
                        const product = products[0];
                        return {
                            id: product.permanentid || product.uniqueId,
                            name: product.ec_name || product.title,
                            price: product.ec_price || 0,
                            image: product.ec_thumbnails || product.ec_image,
                            brand: product.ec_brand || ''
                        };
                    }
                }
            } catch (error) {
                console.warn('Could not extract product data:', error);
            }
            return null;
        }

        // Function to add product to cart
        window.addToCart = function(button) {
            const productData = getProductDataFromElement(button);
            
            if (productData) {
                console.log('Adding to cart:', productData);
                addProductToCart(productData);
                
                // Track add to cart event
                trackAddToCartEvent(productData);
                
                // Visual feedback
                const originalText = button.textContent;
                button.textContent = 'Added!';
                button.style.backgroundColor = '#27ae60';
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.backgroundColor = '';
                }, 2000);
            } else {
                console.warn('Could not get product data for cart');
                // Try alternative method - get data from the product template
                const template = button.closest('atomic-product-template');
                if (template && template.result) {
                    const fallbackData = {
                        id: template.result.permanentid || 'unknown-' + Date.now(),
                        name: template.result.title || 'Product',
                        price: template.result.raw?.ec_price || 0,
                        image: template.result.raw?.ec_thumbnails?.[0] || template.result.raw?.ec_image,
                        brand: template.result.raw?.ec_brand || ''
                    };
                    addProductToCart(fallbackData);
                    trackAddToCartEvent(fallbackData);
                    
                    const originalText = button.textContent;
                    button.textContent = 'Added!';
                    setTimeout(() => {
                        button.textContent = originalText;
                    }, 1500);
                }
            }
        };
    </script>
</body>
</html>