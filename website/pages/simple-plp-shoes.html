<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sports Store - Shoes</title>
    <script type="module" src="https://static.cloud.coveo.com/atomic/v3/atomic.esm.js"></script>
    <link rel="stylesheet" href="https://static.cloud.coveo.com/atomic/v3/themes/coveo.css">
    <link rel="stylesheet" href="../styles/main.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>Sports Store - Shoes</h1>
            <nav class="nav">
                <a href="simple-search.html">Search</a>
                <a href="simple-plp-shoes.html">Shoes</a>
                <a href="simple-plp-hockey.html">Hockey</a>
                <a href="simple-plp-golf.html">Golf</a>
            </nav>
        </header>

        <main class="main-content">
            <atomic-commerce-interface
                organization-id="coveodocumentationtest"
                tracking-id="commerce-docs-demo"
                type="product-listing"
            >
                <atomic-commerce-layout>
                    <atomic-layout-section section="facets">
                        <atomic-commerce-facets></atomic-commerce-facets>
                    </atomic-layout-section>
                    
                    <atomic-layout-section section="main">
                        <atomic-layout-section section="status">
                            <atomic-commerce-query-summary></atomic-commerce-query-summary>
                            <atomic-commerce-sort-dropdown></atomic-commerce-sort-dropdown>
                        </atomic-layout-section>
                        
                        <atomic-layout-section section="results">
                            <atomic-commerce-product-list>
                                <atomic-product-template>
                                    <template>
                                        <div class="grouped-product-card" onclick="handleProductClick(this)" data-product-id="${ec_product_id}" data-click-uri="${clickUri}">
                                            <atomic-product-section-visual class="product-main-image">
                                                <atomic-product-image field="ec_images"></atomic-product-image>
                                            </atomic-product-section-visual>
                                            
                                            <atomic-product-section-name class="product-title">
                                                <atomic-product-text field="ec_name" class="product-link"></atomic-product-text>
                                            </atomic-product-section-name>
                                            
                                            <atomic-product-section-metadata class="product-details">
                                                <atomic-product-text field="ec_brand" class="product-brand"></atomic-product-text>
                                                <atomic-product-text field="ec_category" class="product-category"></atomic-product-text>
                                            </atomic-product-section-metadata>
                                            
                                            <atomic-product-section-emphasized class="product-pricing">
                                                <atomic-product-price currency="CAD"></atomic-product-price>
                                            </atomic-product-section-emphasized>
                                            
                                            <!-- Native Atomic Commerce Product Grouping -->
                                            <atomic-product-section-children class="product-variants">
                                                <atomic-product-children label="Also available in:"></atomic-product-children>
                                            </atomic-product-section-children>
                                        </div>
                                    </template>
                                </atomic-product-template>
                            </atomic-commerce-product-list>
                        </atomic-layout-section>
                        
                        <atomic-layout-section section="pagination">
                            <atomic-commerce-pager></atomic-commerce-pager>
                        </atomic-layout-section>
                    </atomic-layout-section>
                </atomic-commerce-layout>
            </atomic-commerce-interface>
        </main>
    </div>

    <script>
        (async () => {
            await customElements.whenDefined('atomic-commerce-interface');
            
            const commerceInterface = document.querySelector('atomic-commerce-interface');
            
            await commerceInterface.initialize({
                accessToken: 'xxd749992c-d0b5-475f-95e6-671793e6c94a',
                organizationId: 'coveodocumentationtest',
                environment: 'prod',
                analytics: {
                    trackingId: 'commerce-docs-demo'
                },
                context: {
                    language: 'en',
                    country: 'CA',
                    currency: 'CAD',
                    view: {
                        url: 'https://sports-store.com/shoes'
                    }
                }
            });

            // Execute first request for shoes
            await commerceInterface.executeFirstRequest({
                q: 'shoes'
            });

            // Debug response
            commerceInterface.addEventListener('responseReceived', (event) => {
                console.log('SIMPLE SHOES PLP - Products found:', event.detail?.response?.products?.length || 0);
            });
        })();

        // Handle product clicks with proper event logging
        function handleProductClick(element) {
            const productId = element.getAttribute('data-product-id');
            const clickUri = element.getAttribute('data-click-uri');
            
            console.log('Product clicked on shoes PLP:', productId);
            
            // Log click event to Coveo Analytics following commerce protocol
            logCommerceClickEvent(productId, clickUri, 'shoes_category');
            
            // Navigate to product detail page
            window.location.href = `product-detail.html?id=${encodeURIComponent(productId)}`;
        }

        function logCommerceClickEvent(productId, clickUri, contextPage) {
            console.log('Logging commerce click event for product:', productId);
            
            const commerceInterface = document.querySelector('atomic-commerce-interface');
            
            try {
                fetch('https://analytics.cloud.coveo.com/rest/organizations/coveodocumentationtest/analytics/click', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer xxd749992c-d0b5-475f-95e6-671793e6c94a',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        language: 'en',
                        userAgent: navigator.userAgent,
                        customData: {
                            context_website: 'sports-store.com',
                            context_page: contextPage || 'product_listing',
                            ec_product_id: productId,
                            clickUri: clickUri || '',
                            searchHub: 'commerce-docs-demo',
                            category: 'shoes'
                        },
                        anonymous: true,
                        location: window.location.href,
                        referrer: document.referrer || '',
                        title: document.title,
                        actionCause: 'documentClick',
                        searchQueryUid: commerceInterface?.state?.searchResponseId || '',
                        queryPipeline: 'default'
                    })
                }).then(response => {
                    if (response.ok) {
                        console.log('Click event logged successfully');
                    } else {
                        console.warn('Failed to log click event:', response.status);
                    }
                }).catch(error => {
                    console.error('Error logging click event:', error);
                });
                
            } catch (error) {
                console.error('Error in click event logging:', error);
            }
        }
    </script>
</body>
</html>